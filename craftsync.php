<?php
/**
 * @package wp-sync
 * @version 1.0
 */
/*
Plugin Name: wp-sync
Plugin URI: 
Description: 
Author: spartacusxxxxxx
Version: 1.0
Author URI: https://github.com/spartacusxxxxxx
*/


function main()
{

    $PLUGIN_NAME = "wp-sync";
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    $ABS_FILE_NAME_AUTH = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/AUTH.txt';
    $WORK_DIR_NAME = substr($ABS_FILE_NAME_AUTH, 0, strrpos($ABS_FILE_NAME_AUTH, "/") + 1);

    $ABS_FILE_NAME_PROTOTYPES = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prototypes_work.xml';
    $ABS_FILE_NAME_PROTOTYPES_ALL = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prototypes_0.xml';
    $ABS_FILE_NAME_PROTOTYPES_TEST = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prototypes_work_test.xml';
    $ABS_FILE_NAME_PROTOTYPES_TEMP = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prototypes_work_temp.xml';
    $ABS_FILE_NAME_OFFERS = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/offers_work.xml';
    $ABS_FILE_NAME_OFFERS_ALL = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/offers_0.xml';
    $ABS_FILE_NAME_OFFERS_TEST = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/offers_work_test.xml';
    $ABS_FILE_NAME_OFFERS_TEMP = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/offers_work_temp.xml';
    $ABS_FILE_NAME_PRICES = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prices_work.xml';
    $ABS_FILE_NAME_PRICES_TEMP = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/prices_work_temp.xml';
    $ABS_FILE_NAME_INSTOCK = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/instock_work.xml';
    $ABS_FILE_NAME_INSTOCK_TEMP = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/instock_work_temp.xml';
    $ABS_FILE_NAME_PATTERN = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/pattern_work.xml';
    $ABS_FILE_NAME_UPLOAD = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/upload_work.xml';
    $WORK_DIR_UPLOAD = $_SERVER["DOCUMENT_ROOT"] . 'uploads/wpallimport/uploads/';
    $ABS_LOG_FILENAME = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/'.$PLUGIN_NAME.'/SyncLog.txt';
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////AUTH////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    chdir($WORK_DIR_NAME);
    $file_atth = fopen($ABS_FILE_NAME_AUTH, 'r');
    $fread_result_auth = fread($file_atth, filesize($ABS_FILE_NAME_AUTH));
    fclose($file_atth);
    $pieces = explode(";", $fread_result_auth);
    $LOGIN = $pieces[0];
    $PWS = $pieces[1];

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////LOG/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    $graphic_delimiter = "===============================================================================================================================================";
    file_put_contents('SyncLog.txt', date('[Y-m-d H:i:s] ') . print_r($graphic_delimiter, true) . PHP_EOL, FILE_APPEND | LOCK_EX);
    file_put_contents('SyncLog.txt', date('[Y-m-d H:i:s] ') . print_r('=========LOG_INIT=========', true) . PHP_EOL, FILE_APPEND | LOCK_EX);
    file_put_contents('SyncLog.txt', date('[Y-m-d H:i:s] ') . print_r($graphic_delimiter, true) . PHP_EOL, FILE_APPEND | LOCK_EX);
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////FUNCTIONS//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function add_to_log($log_message)
    {
        $graphic_delimiter = "===============================================================================================================================================";
        file_put_contents('SyncLog.txt', date('[Y-m-d H:i:s] ') . print_r($log_message, true) . PHP_EOL, FILE_APPEND | LOCK_EX);
        file_put_contents('SyncLog.txt', date('[Y-m-d H:i:s] ') . print_r($graphic_delimiter, true) . PHP_EOL, FILE_APPEND | LOCK_EX);
    }

    function GetCurlData($CurlUrl, $CurlLogin, $CurlPws)
    {
        $ch_func = curl_init();
        curl_setopt($ch_func, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch_func, CURLOPT_URL, $CurlUrl);
        curl_setopt($ch_func, CURLOPT_USERPWD, "$CurlLogin:$CurlPws");
        $result_func = curl_exec($ch_func);
        curl_close($ch_func);
        return $result_func;
    }

    function SaveFileXML($FileName, $ABSFileName, $result_to_write)
    {
        //print_r($FileName);
        //echo nl2br("\r\n");
        chdir(substr($ABSFileName, 0, strrpos($ABSFileName, "/") + 1));
        $file_xml = fopen($FileName, 'w');
        fwrite($file_xml, $result_to_write);
        fclose($file_xml);
        //$file_xml = mb_convert_encoding($file_xml, 'UTF-8', 'OLD-ENCODING');
        $xml_save = simplexml_load_file($ABSFileName);

        //print_r($FileName);
        //echo nl2br("\r\n");
        $xml_save->asXML($ABSFileName);
        //print_r($FileName);
        //echo nl2br("\r\n");

        return $xml_save;
    }




    function hello_dolly_get_lyric()
    {
        $lyrics = "Hello, Dolly
Well, hello, Dolly
It's so nice to have you back where you belong
You're lookin' swell, Dolly
I can tell, Dolly
You're still glowin', you're still crowin'
You're still goin' strong
We feel the room swayin'
While the band's playin'
One of your old favourite songs from way back when
So, take her wrap, fellas
Find her an empty lap, fellas
Dolly'll never go away again
Hello, Dolly
Well, hello, Dolly
It's so nice to have you back where you belong
You're lookin' swell, Dolly
I can tell, Dolly
You're still glowin', you're still crowin'
You're still goin' strong
We feel the room swayin'
While the band's playin'
One of your old favourite songs from way back when
Golly, gee, fellas
Find her a vacant knee, fellas
Dolly'll never go away
Dolly'll never go away
Dolly'll never go away again";

        // Here we split it into lines
        $lyrics = explode("\n", $lyrics);

        // And then randomly choose a line
        return wptexturize($lyrics[mt_rand(0, count($lyrics) - 1)]);
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////








    function hello_dolly()
    {
        $chosen = hello_dolly_get_lyric();
        echo "<p id='dolly'>$chosen</p>";
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /*
         $ABS_FILE_NAME_AUTH = $_SERVER["DOCUMENT_ROOT"] . '/wp-content/plugins/wp-sync/AUTH.txt';
         $WORK_DIR_NAME = substr($ABS_FILE_NAME_AUTH, 0, strrpos($ABS_FILE_NAME_AUTH, "/") + 1);
         chdir($WORK_DIR_NAME);
         $file_atth = fopen($ABS_FILE_NAME_AUTH, 'r');
         $fread_result_auth = fread($file_atth, filesize($ABS_FILE_NAME_AUTH));
         fclose($file_atth);
         $pieces = explode(";", $fread_result_auth);
         $LOGIN = $pieces[0];
         $PWS = $pieces[1];

         $url_instock = "";// . $TimeLastSync_instock;

         $result_instock = GetCurlData($url_instock, $LOGIN, $PWS);
         echo "<p id='dolly'>$result_instock</p>";
        */




    }


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////END OF FUNCTIONS///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////GO SCRIPT HERE/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////set_time_limit//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
set_time_limit(0);
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////end of set_time_limit///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    if (filesize($ABS_LOG_FILENAME) > 20000000)
    {
        unlink($ABS_LOG_FILENAME);
        add_to_log("TOO_BIG_LOG");
    }


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////timeLastSync_prototypes///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОпределЯем времЯ последней сихронизации длЯ запроса прототипов
     */
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_PROTOTYPES))
    {
        $xml_prototypes = simplexml_load_file($ABS_FILE_NAME_PROTOTYPES);
        if ($xml_prototypes->xpath('//timeLastSync'))
        {
            $timeLastSync_node_prototypes = $xml_prototypes->xpath('//timeLastSync');
            $TimeLastSync_prototypes = $timeLastSync_node_prototypes[0];
            add_to_log("времЯ последней сихронизации длЯ прототипов: " . $TimeLastSync_prototypes);
        }
    } else
    {
        $TimeLastSync_prototypes = 0;
        add_to_log("времЯ последней сихронизации длЯ прототипов: " . $TimeLastSync_prototypes);
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////end of timeLastSync_prototypes///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////query of prototypes//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОтправлЯем запрос прототипов
     */
    $url_prototypes = "" . $TimeLastSync_prototypes;
    $result_prototypes = GetCurlData($url_prototypes, $LOGIN, $PWS);
//print_r($result_prototypes);
//echo nl2br("\r\n");
    add_to_log("запрос прототипов: ");
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////end of query of prototypes///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////prototypes_work.xml///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * Создаём файл prototypes_work.xml  в текущей директории компонента в кодировке UTF-8
     */
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    chdir($WORK_DIR_NAME);
    /**
     * Если обновилсЯ существующий прототип то находим его в prototypes_work.xml и изменЯем.
     * Если прототип не найден, считаем что это новый прототип и добавлЯем его в список.
     */
//Проверка необходима длЯ использованиЯ xpath
    if (file_exists($ABS_FILE_NAME_PROTOTYPES))
    {
        /**
         * ОпределЯем источник данных длЯ $xml_prototypes_temp
         */
        $xml_prototypes = simplexml_load_file($ABS_FILE_NAME_PROTOTYPES);
        add_to_log("файл prototypes_work.xml уже существует: ");

        $file_prototypes_work_temp_xml = fopen('prototypes_work_temp.xml', 'w');
        fwrite($file_prototypes_work_temp_xml, $result_prototypes);
        fclose($file_prototypes_work_temp_xml);
        //$file_prototypes_work_temp_xml = mb_convert_encoding($file_prototypes_work_temp_xml, 'UTF-8', 'OLD-ENCODING');
        $xml_prototypes_temp = simplexml_load_file($ABS_FILE_NAME_PROTOTYPES_TEMP);

        /**
         * Включил проверку на доступность посредника, если не доступен, то сразу выходим, а $xml_prototypes_temp
         * перезапишетсЯ при следующем обращении
         */
        $xml_prototypes_temp_node_title = $xml_prototypes_temp->xpath('//title');
        $xml_prototypes_temp_node_title_arr = (array)$xml_prototypes_temp_node_title[0];
        if ($xml_prototypes_temp_node_title_arr[0] == 'Error')
        {
            add_to_log("CRAFTMIDDLE_IS_DEAD");
            $CRAFTMIDDLE_IS_DEAD = TRUE;
            return;
        }
        $xml_prototypes_temp->asXML($ABS_FILE_NAME_PROTOTYPES_TEMP);
        $xml_prototypes_temp = simplexml_load_file($ABS_FILE_NAME_PROTOTYPES_TEMP);
        //print_r($xml_prototypes_temp);
        //echo nl2br("\r\n");
        add_to_log("загрузили файл prototypes_work_temp.xml c помощью Curl c текущей временной меткой");
        /////////////////////////////////////////////////////////////////////////////////////////////////
        /**
         * Считываем времЯ последней сихнронизации с файла $xml_prototypes_temp
         */
        $proto_temp_upper_node = $xml_prototypes_temp->xpath('//deviceInfoListDataWs');
        $proto_temp_upper_node = (array)$proto_temp_upper_node[0];
        $proto_temp_last_time_sync = $proto_temp_upper_node[timeLastSync];
        /**
         * Записываем времЯ последней сихнронизации в файл $xml_prototypes и сохранЯем его
         */
        $proto_work_upper_node = $xml_prototypes->xpath('//deviceInfoListDataWs');
        $proto_work_upper_node[0]->timeLastSync = $proto_temp_last_time_sync;
        $xml_prototypes->asXML($ABS_FILE_NAME_PROTOTYPES);

    } else
    {
        $xml_prototypes = SaveFileXML('prototypes_work.xml', $ABS_FILE_NAME_PROTOTYPES, $result_prototypes);
        add_to_log("Поскольку файл prototypes_work.xml ранее не сущестовал, то загрузили его из результата запроса с текущей временной меткой : ");
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////end of prototypes_work.xml///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////timeLastSync_offers//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    chdir($WORK_DIR_NAME);
    /**
     * ОпределЯем времЯ последней сихронизации длЯ запроса аккумулЯторов
     */
    if (file_exists($ABS_FILE_NAME_OFFERS))
    {
        $xml_offers = simplexml_load_file($ABS_FILE_NAME_OFFERS);
        //echo "The file $ABS_FILE_NAME_OFFERS exists";
        if ($xml_offers->xpath('//timeLastSync'))
        {
            $timeLastSync_node_offers = $xml_offers->xpath('//timeLastSync');
            //echo $timeLastSync_node[0];
            $TimeLastSync_offers = $timeLastSync_node_offers[0];
            add_to_log("времЯ последней сихронизации длЯ аккумулЯторов: " . $TimeLastSync_offers);
        }
    } else
    {
        $TimeLastSync_offers = 0;
        add_to_log("времЯ последней сихронизации длЯ аккумулЯторов: " . $TimeLastSync_offers);
        //echo "The file $ABS_FILE_NAME_OFFERS does not exist";
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////end of timeLastSync_offers///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////query of offers//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОтправлЯем запрос аккумулЯторов
     */
    $url_offers = "" . $TimeLastSync_offers;
    $result_offers = GetCurlData($url_offers, $LOGIN, $PWS);
    add_to_log("запрос аккумулЯторов: ");
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////end of query of offers//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////OFFERS///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * Создаём файл offers_work.xml  в текущей директории компонента в кодировке UTF-8
     */
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_OFFERS))
    {
        $THERE_IS_FIRST_UPLOAD = FALSE;
        add_to_log("файл offers_work.xml уже существовал, установили флаг THERE_IS_FIRST_UPLOAD в FALSE ");
        /**
         * ОпределЯем источник данных длЯ offers_work_temp
         */
        $xml_offers_temp = SaveFileXML('offers_work_temp.xml', $ABS_FILE_NAME_OFFERS_TEMP, $result_offers);
        $xml_offers_temp = simplexml_load_file($ABS_FILE_NAME_OFFERS_TEMP);
        add_to_log("файл xml_offers_temp загрузили из результата запроса по аккумулЯторам");
        /**
         * Ничего не сравниваем - просто заменЯем старые данные новыми
         */
        $xml_offers_temp->asXML($ABS_FILE_NAME_OFFERS);
        $xml_offers = simplexml_load_file($ABS_FILE_NAME_OFFERS);
        add_to_log("заменили файл xml_offers_work полностью на xml_offers_temp без каких либо сравнений или условий");
    } else
    {

        $xml_offers = SaveFileXML('offers_work.xml', $ABS_FILE_NAME_OFFERS, $result_offers);
        add_to_log("загрузили файл xml_offers из результатов запроса по аккумуляторам ");
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////END OF OFFERS////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////timeLastSync_prices//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОпределЯем времЯ последней сихронизации длЯ запроса цен
     */
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_PRICES))
    {
        $xml_prices = simplexml_load_file($ABS_FILE_NAME_PRICES);
        // echo "The file $ABS_FILE_NAME_PRICES exists";
        if ($xml_prices->xpath('//timeLastSync'))
        {
            $timeLastSync_node_prices = $xml_prices->xpath('//timeLastSync');
            $TimeLastSync_prices = $timeLastSync_node_prices[0];
            add_to_log("времЯ последней сихронизации длЯ цен: " . $TimeLastSync_prices);
        }
    } else
    {
        $TimeLastSync_prices = 0;
        add_to_log("времЯ последней сихронизации длЯ цен: " . $TimeLastSync_prices);
        //echo "The file $ABS_FILE_NAME_PROTOTYPES does not exist";
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////end of timeLastSync_prices///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////PRICES///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОтправлЯем запрос цен
     */
    add_to_log("запрос цен: ");
    $url_prices = "" . $TimeLastSync_prices;
    $result_prices = GetCurlData($url_prices, $LOGIN, $PWS);
    /**
     * Создаём файл prices_work.xml  в текущей директории компонента в кодировке UTF-8
     */
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_PRICES))
    {
        $THERE_IS_FIRST_UPLOAD = FALSE;
        add_to_log("файл prices_work.xml уже существовал, установили флаг THERE_IS_FIRST_UPLOAD в FALSE ");
        /**
         * ОпределЯем источник данных длЯ prices_work_temp
         */
        $xml_prices_temp = SaveFileXML('prices_work_temp.xml', $ABS_FILE_NAME_PRICES_TEMP, $result_prices);
        $xml_prices_temp = simplexml_load_file($ABS_FILE_NAME_PRICES_TEMP);
        add_to_log("файл xml_prices_temp загрузили из результата запроса по ценам");
        /**
         * Ничего не сравниваем - просто заменЯем старые данные новыми
         */
        $xml_prices_temp->asXML($ABS_FILE_NAME_PRICES);
        $xml_prices = simplexml_load_file($ABS_FILE_NAME_PRICES);
        add_to_log("заменили файл xml_prices_work полностью на xml_prices_temp без каких либо сравнений или условий");
    } else
    {
        $xml_prices = SaveFileXML('prices_work.xml', $ABS_FILE_NAME_PRICES, $result_prices);
        add_to_log("загрузили файл xml_prices из результатов запроса по ценам ");
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////END_OF_PRICES////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////timeLastSync_instock/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОпределЯем времЯ последней сихронизации длЯ запроса наличиЯ
     */
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_INSTOCK))
    {
        $xml_instock = simplexml_load_file($ABS_FILE_NAME_INSTOCK);
        // echo "The file $ABS_FILE_NAME_INSTOCK exists";
        if ($xml_instock->xpath('//timeLastSync'))
        {
            $timeLastSync_node_instock = $xml_instock->xpath('//timeLastSync');
            $TimeLastSync_instock = $timeLastSync_node_instock[0];
            add_to_log("времЯ последней сихронизации длЯ наличиЯ: " . $TimeLastSync_instock);
        }
    } else
    {
        $TimeLastSync_instock = 0;
        add_to_log("времЯ последней сихронизации длЯ наличиЯ: " . $TimeLastSync_instock);
        //echo "The file $ABS_FILE_NAME_INSTOCK does not exist";
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////enf of timeLastSync_instock//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////INSTOCK///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * ОтправлЯем запрос наличиЯ
     */
    $url_instock = "" . $TimeLastSync_instock;
    $result_instock = GetCurlData($url_instock, $LOGIN, $PWS);
    add_to_log("запрос наличиЯ: ");
    /**
     * Создаём файл instock_work.xml  в текущей директории компонента в кодировке UTF-8
     */
    chdir($WORK_DIR_NAME);
    if (file_exists($ABS_FILE_NAME_INSTOCK))
    {
        $THERE_IS_FIRST_UPLOAD = FALSE;
        add_to_log("файл instock_work.xml уже существовал, установили флаг THERE_IS_FIRST_UPLOAD в FALSE ");
        /**
         * ОпределЯем источник данных длЯ instock_work_temp
         */
        $xml_instock_temp = SaveFileXML('instock_work_temp.xml', $ABS_FILE_NAME_INSTOCK_TEMP, $result_instock);
        $xml_instock_temp = simplexml_load_file($ABS_FILE_NAME_INSTOCK_TEMP);
        add_to_log("файл xml_instock_temp загрузили из результата запроса по наличию");
        /**
         * Ничего не сравниваем - просто заменЯем старые данные новыми
         */
        $xml_instock_temp->asXML($ABS_FILE_NAME_INSTOCK);
        $xml_instock = simplexml_load_file($ABS_FILE_NAME_INSTOCK);
        add_to_log("заменили файл xml_instock_work полностью на xml_instock_temp без каких либо сравнений или условий");
    } else
    {
        $xml_instock = SaveFileXML('instock_work.xml', $ABS_FILE_NAME_INSTOCK, $result_instock);
        add_to_log("загрузили файл xml_prices из результатов запроса по ценам ");
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////END_OF_INSTOCK///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////PROTOTYPE_0_AND_OFFERS_0/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /**
     * Запрос и сохранение всех прототипов и всех аккумулЯторов в отдельные файл, если есть хотЯ бы одно предложение с текущей временной меткой
     */
    if ($xml_offers->xpath('//dataWs'))
    {
        add_to_log("поскольку xml_offers содержит хотЯ бы один элемент, то далее загружаем прототипы и аккумулЯторы в нулевой временной меткой для сравнениЯ  ");
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////prototypes///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $url_prototypes_0 = "";
        $result_prototypes_0 = GetCurlData($url_prototypes_0, $LOGIN, $PWS);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $xml_prototypes_0 = SaveFileXML('prototypes_0.xml', $ABS_FILE_NAME_PROTOTYPES_ALL, $result_prototypes_0);
        add_to_log("создаём xml_prototypes_0.xml из результатов запроса result_prototypes_0 ");
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////offers//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $url_offers_0 = "";
        $result_offers_0 = GetCurlData($url_offers_0, $LOGIN, $PWS);
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $xml_offers_0 = SaveFileXML('offers_0.xml', $ABS_FILE_NAME_OFFERS_ALL, $result_offers_0);
        add_to_log("создаём xml_offers_0 вне зависимости от флага TEST_CASE из результатов запроса result_offers_0 ");
    } else
    {
        add_to_log("нет ни одного элемента в xml_offers");
        if (file_exists($ABS_FILE_NAME_PROTOTYPES_ALL))
        {
            $xml_prototypes_0 = simplexml_load_file($ABS_FILE_NAME_PROTOTYPES_ALL);
            add_to_log("поскольку нет ни одного элемента в xml_offers создаём xml_prototypes_0");
        }
        if (file_exists($ABS_FILE_NAME_OFFERS_ALL))
        {
            $xml_offers_0 = simplexml_load_file($ABS_FILE_NAME_OFFERS_ALL);
            add_to_log("поскольку нет ни одного элемента в xml_offers создаём xml_offers_0");
        }

    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////END_OF_PROTOTYPE_0_AND_OFFERS_0//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




} //end of main


main();
//add_action('admin_notices', 'hello_dolly');





?>
